name: Password Vault CI/CD

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # Login to Docker Hub
    - name: Login DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USER }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # Build immutable image
    - name: Build Image
      run: |
        docker build -t ${{ secrets.DOCKERHUB_USER }}/password-vault:${{ github.sha }} .
        docker tag ${{ secrets.DOCKERHUB_USER }}/password-vault:${{ github.sha }} ${{ secrets.DOCKERHUB_USER }}/password-vault:latest

    # Scan vulnerabilities
    - name: Trivy Scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ secrets.DOCKERHUB_USER }}/password-vault:${{ github.sha }}
        severity: CRITICAL,HIGH
        exit-code: 1

    # Push both versioned & latest tags
    - name: Push Image
      run: |
        docker push ${{ secrets.DOCKERHUB_USER }}/password-vault:${{ github.sha }}
        docker push ${{ secrets.DOCKERHUB_USER }}/password-vault:latest

    # Install cosign (idempotent)
    - name: Install Cosign
      uses: sigstore/cosign-installer@v3

    # Sign both images
    - name: Sign Image
      env:
        COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
      run: |
        echo "${{ secrets.COSIGN_PRIVATE_KEY }}" > cosign.key
        cosign sign --key cosign.key ${{ secrets.DOCKERHUB_USER }}/password-vault:${{ github.sha }}
        cosign sign --key cosign.key ${{ secrets.DOCKERHUB_USER }}/password-vault:latest

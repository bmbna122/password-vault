name: Restore Supabase Backup

on:
  workflow_dispatch:
    inputs:
      artifact:
        description: "Backup artifact name"
        required: true

jobs:
  restore:
    runs-on: ubuntu-latest

    steps:
    - name: Install tools
      run: sudo apt-get update && sudo apt-get install -y postgresql-client openssl

    - name: Download Backup
      uses: actions/download-artifact@v4
      with:
        name: ${{ github.event.inputs.artifact }}

    - name: Decrypt & Restore
      run: |
        FILE=$(ls *.enc)
        openssl enc -aes-256-cbc -d -in $FILE -out restore.sql.gz -k "${{ secrets.BACKUP_PASSWORD }}"
        gunzip restore.sql.gz
        psql "${{ secrets.RESTORE_DB_URL }}" < restore.sql
